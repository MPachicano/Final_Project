---
title: "Final_Project"
author: "Maricarmen Pachicano"
date: "11/30/2021"
output: html_document
---

## htseq-count input
I have imported a total of 80 htseq-count files into a directory, and is displayed in table sampleTable. There are n = 40 from each treatment group in my data file (20 Female, 20 Male for mulitple comparisons).

## Creating a variable called 'directory' which points to where my output files are located.
```{r}
directory <- "/Users/maricarmen/Desktop/files"
```
## Specifying files that contain "treated" in the filename, and using that to identify the condition status.
```{r}
sampleFiles <- grep("treated",list.files(directory),value=TRUE)
sampleCondition <- sub("(.*treated).*","\\1",sampleFiles)
sampleType <- sub(".*treated","",sampleFiles)
sampleTable <- data.frame(sampleName = sampleFiles,
                          fileName = sampleFiles,
                          condition = sampleCondition,
                          type = sampleType)
sampleTable$condition <- factor(sampleTable$condition)
sampleTable$type <- factor(sampleTable$type)
```

## Building the DESeqDataSet
```{r}
library("DESeq2")
ddsHTSeq <- DESeqDataSetFromHTSeqCount(sampleTable = sampleTable,
                                       directory = directory,
                                       design= ~ condition)
ddsHTSeq
```
# Pre-filtering
```{r}
keep <- rowSums(counts(ddsHTSeq)) >= 10
dds <- ddsHTSeq[keep,]
```

# Setting factor levels
```{r}
dds$condition <- factor(dds$condition, levels = c("untreated","treated"))
```

# Differential Expression Analysis
```{r}
dds <- DESeq(dds)
res <- results(dds)
res <- results(dds, name="condition_treated_vs_untreated")
res
```

# Log fold change shrinkage
```{r}
resultsNames(dds)
```
```{r}
resLFC <- lfcShrink(dds, coef="condition_treated_vs_untreated", type="apeglm")
resLFC
```

# Ordering results table (by p-values)
```{r}
resOrdered <- res[order(res$pvalue),]
```
```{r}
summary(res)
```

# How many p-values are less than 0.1?
```{r}
sum(res$padj < 0.1, na.rm=TRUE)
```

# Adjusting p-value to 0.5
```{r}
res05 <- results(dds, alpha=0.05)
summary(res05)
```

# How many p-values are less than 0.5?
```{r}
sum(res05$padj < 0.05, na.rm=TRUE)
```

# MAPlot for shrunkin log2 fold changes
```{r}
plotMA(resLFC, ylim=c(-2,2))
idx <- identify(res$baseMean, res$log2FoldChange)
rownames(res)[idx]
```
# Alternative shrinkage estimators
```{r}
resultsNames(dds)
```

# Setting 'coef = 2' (this may take awhile, grab a coffee)
```{r}
resNorm <- lfcShrink(dds, coef=2, type="normal")
resAsh <- lfcShrink(dds, coef=2, type="ashr")
```
```{r}
resNorm <- lfcShrink(dds, coef=2, type="normal")
resAsh <- lfcShrink(dds, coef=2, type="ashr")
```

```{r}
par(mfrow=c(1,3), mar=c(4,4,2,1))
xlim <- c(1,1e5); ylim <- c(-3,3)
plotMA(resLFC, xlim=xlim, ylim=ylim, main="apeglm")
plotMA(resNorm, xlim=xlim, ylim=ylim, main="normal")
plotMA(resAsh, xlim=xlim, ylim=ylim, main="ashr")
```
# Plot counts
```{r}
plotCounts(dds, gene=which.min(res$padj), intgroup="condition")
```
# Plotting using ggplot
```{r}
d <- plotCounts(dds, gene=which.min(res$padj), intgroup="condition", 
                returnData=TRUE)
library("ggplot2")
ggplot(d, aes(x=condition, y=count)) + 
  geom_point(position=position_jitter(w=0.1,h=0)) + 
  scale_y_log10(breaks=c(25,100,400))
```
# Multi-factor design 
# Our sample population has a condition of interest (treated for liver cancer or untreated), but we also have the Sex of each patient under "type". By using the colData function, we see that we have to chop/clean up our Type names.
```{r}
colData(dds)
```

# First, I create a copy of the DDS so we can run a multi-factor analysis.
```{r}
ddsMF <- dds
```

# Then, we change how "Type" is displayed for each sample participant.
```{r}
levels(ddsMF$type)
```

# We will chop/clean up "Type" so that it only specifies F for female patient or M for male patient. 
```{r}
levels(ddsMF$type) <- sub("_.*", "", levels(ddsMF$type))
levels(ddsMF$type)
```

# As condition is the variable of interest, we put it at the end of our formula. We then re-run DeSeq analysis:
```{r}
design(ddsMF) <- formula(~ type + condition)
ddsMF <- DESeq(ddsMF)
```

# We access results using the results function:
```{r}
resMF <- results(ddsMF)
head(resMF)
```

# Now we use the contrast function to extract log2 fold changes while specifying Type
```{r}
resMFType <- results(ddsMF,
                     contrast=c("type", "F", "M"))
head(resMFType)
```

# Info on results columns
```{r}
mcols(res)$description
```

# Exporting to CSV file (when ran, this will export a CSV to your Desktop)
```{r}
write.csv(as.data.frame(resOrdered), 
          file="condition_treated_results.csv")
```

# Data transformations and visualizations!
# Extracting transformed values (note: this takes a VERY long time to run, take a break go get a coffee)
```{r}
vsd <- vst(dds, blind=FALSE)
rld <- rlog(dds, blind=FALSE)
head(assay(vsd), 3)
```

# Effects on transformation on variance (Standard Deviation) for the normal logarithm transformation (ntd)
```{r}
# this gives log2(n + 1)
ntd <- normTransform(dds)
library("vsn")
meanSdPlot(assay(ntd))
```
# Effects on transformation on variance (Standard Deviation) for the variance stabilizing transformation (vsd)
```{r}
meanSdPlot(assay(vsd))
```
# Effects on transformation on variance (Standard Deviation) for the regularized log transformation (rld)
```{r}
meanSdPlot(assay(rld))
```
# Heatmap of count matrix
# Known issue: I had to remove colnames because they were too complicated, and the heatmap wasn't being displayed. Will need to come back to this. Other known issue: Not sure why female and male are not clumped together, I think this has to do with how my files are ordered. I need to come back to this. 
# This is a heatmap with both condition and type being analyzed. Multi-factor design. 
```{r}
library("pheatmap")
select <- order(rowMeans(counts(ddsMF,normalized=TRUE)),
                decreasing=TRUE)[1:20]
df <- as.data.frame(colData(ddsMF)[,c("condition","type")])
pheatmap(assay(ntd)[select,], cluster_rows=FALSE, show_rownames=FALSE, show_colnames = FALSE,
         cluster_cols=FALSE, annotation_col=df)
```
# Heatmap using ntd data described above.
```{r}
library("pheatmap")
select <- order(rowMeans(counts(dds,normalized=TRUE)),
                decreasing=TRUE)[1:20]
df <- as.data.frame(colData(ddsMF)[,c("condition","type")])
pheatmap(assay(ntd)[select,], cluster_rows=FALSE, show_rownames=FALSE, show_colnames = FALSE,
         cluster_cols=FALSE, annotation_col=df)
```
# Heatmap using vsd data described above.
```{r}
pheatmap(assay(vsd)[select,], cluster_rows=FALSE, show_rownames=FALSE, show_colnames = FALSE,
         cluster_cols=FALSE, annotation_col=df)
```

# Heatmap using rld data described above.
```{r}
pheatmap(assay(rld)[select,], cluster_rows=FALSE, show_rownames=FALSE, show_colnames = FALSE,
         cluster_cols=FALSE, annotation_col=df)
```
# Sample clustering 
```{r}
sampleDists <- dist(t(assay(vsd)))
```

# Creating a heatmap of the sample-to-sample distances.
```{r}
library("pheatmap")
library("RColorBrewer")
sampleDistMatrix <- as.matrix(sampleDists)
rownames(sampleDistMatrix) <- paste(vsd$condition)
colnames(sampleDistMatrix) <- NULL
colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)
pheatmap(sampleDistMatrix,
         clustering_distance_rows=sampleDists,
         clustering_distance_cols=sampleDists,
         col=colors)
```
# PCA plot using vsd 
```{r}
plotPCA(vsd, intgroup="condition", ntop = 500, returnData = FALSE)
```
# Variations to the standard workflow!
# Performing Wald test on dataset
```{r}
dds <- estimateSizeFactors(dds)
dds <- estimateDispersions(dds)
dds <- nbinomWaldTest(dds)
```

# Performing Liklihood ratio test on dataset
```{r}
dds <- DESeq(dds, test="LRT", reduced=~1)
res <- results(dds)
```

